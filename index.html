<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#FFFCF5">
    
    <title>Travel Planner (UI Fixes)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            /* ğŸ¨ æ–‡é’åœ°åœ–é…è‰²ç›¤ (Earth Tones) */
            --bg-color: #Fdfbf7;        /* ç¾Šçš®ç´™ç™½ */
            --text-main: #4a403a;       /* æ·±è¤ */
            --text-sub: #8c837b;        /* æ·ºè¤ */
            
            --accent-main: #d4a373;     /* æ‹¿éµé‡‘ */
            --accent-green: #ccd5ae;    /* æŠ¹èŒ¶ */
            --accent-blue: #a2d2ff;     /* éœ§éœ¾è— */
            --accent-pink: #e5989b;     /* ä¹¾ç‡¥ç«ç‘° */
            --accent-red: #d62828;      /* å°æ³¥ç´… */
            --accent-purple: #b5838d;   /* èŠ‹æ³¥ç´« */
            
            --card-bg: rgba(255, 255, 255, 0.85); /* ç¨å¾®é€æ˜ä¸€é»ï¼Œé€å‡ºèƒŒæ™¯ */
            --safe-bottom: env(safe-area-inset-bottom);
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            position: fixed;
            overflow: hidden;
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none; 
            user-select: none; 
            -webkit-user-select: none;
            
            /* ğŸŒ ä¸–ç•Œåœ°åœ–èƒŒæ™¯ (SVG Data URI - ç°¡åŒ–ç‰ˆä¸–ç•Œåœ°åœ–è¼ªå»“) */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1000' height='500' viewBox='0 0 1000 500'%3E%3Cg fill='%23d4a373' fill-opacity='0.12'%3E%3Cpath d='M195.5 127.5c-4.5-2-8.5.5-9 4.5-.5 3 2.5 6.5 6 7.5 3.5.5 6.5-1.5 8-4 2-3.5 1-7-2.5-8.5l-2.5.5zm168.5 70c-3.5-1-6.5 1.5-5 4.5 1 3.5 4.5 4.5 7.5 2.5 3.5-1.5 3.5-5.5 1.5-8.5-1-1.5-2.5-2-4 1.5zm-135 55c-3.5-1-6 2.5-5 5.5 1 3.5 4.5 4.5 7.5 2 3-2 3-5.5 1-8-1-1.5-2-2-3.5.5zm260-45c-3.5 0-5.5 2-5.5 5 0 3 3 5 5.5 5 3 0 5.5-2 5.5-5 0-3-2.5-5-5.5-5zm-45 115c-3 1-4 4-3 6.5 1 3 4 4 6.5 3 3-1 4-4 3-6.5-1-3-4-4-6.5-3zm-230-50c-3 2-3 5.5-1 8 2 3 5.5 3 8 1 3-2 3-5.5 1-8-2-3-5.5-3-8-1zm200 30c-3 1-4 4-3 7 1 3 4 4 7 3 3-1 4-4 3-7-1-3-4-4-7-3zm-105-65c-3 2-3 5.5-1 8 2 3 5.5 3 8 1 3-2 3-5.5 1-8-2-3-5.5-3-8-1zm-160 130c-2.5 2.5-2 6 .5 8.5 2.5 2.5 6 2 8.5-.5 2.5-2.5 2-6-.5-8.5-2.5-2-6-2-8.5.5zm450-95c-2.5 2.5-2 6 .5 8.5 2.5 2.5 6 2 8.5-.5 2.5-2.5 2-6-.5-8.5-2.5-2.5-6-2-8.5.5zm-70 130c-2 2.5-1.5 6 1 8 2.5 2 6 1.5 8-1 2-2.5 1.5-6-1-8-2.5-2-6-1.5-8 1zm-470-45c-2 2.5-1.5 6.5 1 8.5 2.5 2 6.5 1.5 8.5-1 2-2.5 1.5-6.5-1-8.5-2.5-2-6.5-1.5-8.5 1zM850 150c-10 5-15 20-10 30 5 10 20 15 30 10 10-5 15-20 10-30-5-10-20-15-30-10zM750 350c-8 6-6 20 4 26 10 6 24-4 20-16-2-10-16-14-24-10zM150 350c5 10 20 10 25 0 5-10-5-20-15-20-10 0-15 10-10 20z'/%3E%3C/g%3E%3C/svg%3E");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        input, textarea {
            user-select: text;
            -webkit-user-select: text;
        }

        #root {
            height: 100dvh; 
            width: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .scroll-container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: calc(100px + var(--safe-bottom));
            position: relative;
            z-index: 10;
            overscroll-behavior-y: contain; 
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .tab-bar-glass {
            background: rgba(255, 255, 255, 0.90);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(212, 163, 115, 0.2); /* é‚Šæ¡†æ”¹ç‚ºæ‹¿éµè‰² */
            box-shadow: 0 -4px 30px rgba(0,0,0,0.05);
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 50;
            border-radius: 24px 24px 0 0;
        }

        /* éƒµæˆ³é¢¨æ ¼ä¾¿åˆ©è²¼ */
        .sticky-note {
            background-color: #fffcf0;
            border: 1px solid #e6dcc8;
            padding: 12px 14px;
            margin-top: 10px;
            border-radius: 4px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.03);
            font-size: 0.9rem;
            color: #5d5550;
            line-height: 1.6;
            position: relative;
            transform: rotate(-0.5deg);
        }
        /* è²¼ç´™åœ–å±¤ */
        .sticker {
            position: absolute;
            pointer-events: none;
            z-index: 0;
            opacity: 0.9; /* è²¼ç´™è¦æ¸…æ¥šä¸€é» */
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.1)); /* è²¼ç´™é™°å½± */
            transition: transform 0.3s ease;
        }
        
        .bg-sticker-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .page-enter { animation: pageSlideUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        @keyframes pageSlideUp { 
            0% { opacity: 0; transform: translateY(20px) scale(0.98); } 
            100% { opacity: 1; transform: translateY(0) scale(1); } 
        }

        .stagger-item { opacity: 0; animation: itemPop 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        @keyframes itemPop { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        @keyframes modalUp {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-modal { animation: modalUp 0.25s cubic-bezier(0.2, 0.9, 0.2, 1) forwards; }

        .input-cute {
            background: #FFF;
            border: 2px solid #E8E0D5;
            border-radius: 12px;
            padding: 12px 14px;
            width: 100%;
            outline: none;
            font-size: 1rem;
            color: var(--text-main);
            font-weight: 500;
            transition: all 0.3s;
            margin-bottom: 12px;
            box-shadow: inset 1px 1px 3px rgba(0,0,0,0.03);
        }
        .input-cute:focus { 
            border-color: var(--accent-main); 
            background: #fffefb;
            box-shadow: 0 0 0 3px rgba(212, 163, 115, 0.2);
        }

        .card-cute {
            background: var(--card-bg);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.8);
            box-shadow: 0 4px 20px rgba(212, 163, 115, 0.1); /* æš–è‰²é™°å½± */
            backdrop-filter: blur(12px);
        }

        .card-polaroid {
            background: #FFF;
            padding: 10px 10px 30px 10px;
            border-radius: 2px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            transform: rotate(-1deg);
            transition: transform 0.2s;
        }
        .card-polaroid:hover {
            transform: rotate(0deg) scale(1.02);
            z-index: 10;
        }
        .polaroid-img {
            width: 100%;
            aspect-ratio: 1/1;
            background-color: #f4f4f4;
            object-fit: cover;
            border: 1px solid #eee;
            margin-bottom: 8px;
        }

        .btn-pill {
            border-radius: 99px;
            font-weight: 700;
            letter-spacing: 0.5px;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation; 
        }
        .btn-pill:active:not(:disabled) {
            transform: scale(0.96);
            box-shadow: none;
        }
        .btn-pill:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary { background: var(--accent-main); color: white; }
        .btn-secondary { background: var(--accent-blue); color: white; }
        .btn-success { background: var(--accent-green); color: white; }
        .btn-warning { background: var(--accent-yellow); color: #594a42; }
        .btn-purple { background: var(--accent-purple); color: white; }
        .btn-danger { background: var(--accent-red); color: white; }

        .date-active {
            background-color: var(--accent-green);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(204, 213, 174, 0.6);
        }
        .date-active-snow {
            background-color: var(--accent-blue);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(162, 210, 255, 0.6);
        }
        .date-inactive {
            background-color: rgba(255,255,255,0.7);
            color: #aaa;
            border: 1px solid #e0e0e0;
            backdrop-filter: blur(4px);
        }

        .pb-safe { padding-bottom: calc(24px + env(safe-area-inset-bottom)); }

        .toast-enter { animation: toastSlideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes toastSlideUp { from { transform: translate(-50%, 120%); } to { transform: translate(-50%, 0); } }

        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Landing Page - Passport Style */
        .landing-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 30px;
            background: transparent;
            position: relative;
            z-index: 20;
        }
        .passport-card {
            background: #fff;
            width: 100%;
            max-width: 320px;
            border-radius: 20px;
            padding: 40px 30px;
            box-shadow: 0 20px 50px rgba(212, 163, 115, 0.25);
            border: 1px solid rgba(255,255,255,0.8);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(20px);
            background: rgba(255,255,255,0.85);
        }
        /* Passport decorative lines */
        .passport-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 8px;
            background: repeating-linear-gradient(45deg, #e5989b, #e5989b 10px, transparent 10px, transparent 20px, #a2d2ff 20px, #a2d2ff 30px, transparent 30px, transparent 40px);
        }
        .passport-card::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; width: 100%; height: 8px;
            background: repeating-linear-gradient(45deg, #ccd5ae, #ccd5ae 10px, transparent 10px, transparent 20px, #d4a373 20px, #d4a373 30px, transparent 30px, transparent 40px);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyDbYkxvrEFMfltDnn_8fxLpPLDLZU3HscQ",
            authDomain: "travel-a01b4.firebaseapp.com",
            projectId: "travel-a01b4",
            storageBucket: "travel-a01b4.firebasestorage.app",
            messagingSenderId: "879602910910",
            appId: "1:879602910910:web:5036f88cc2581c4761c0ef"
        };

        if (firebase.apps.length === 0) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        const Icon = ({ name, size = 20, className, color = "currentColor", strokeWidth = 2.5 }) => {
            const iconData = lucide.icons[name];
            if (!iconData) return null;
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {iconData.map((child, index) => React.createElement(child[0], { ...child[1], key: index }))}
                </svg>
            );
        };

        const defaultSettings = { title: 'My Awesome Trip', startDate: '2026-01-18', duration: 5, bgIcon: 'âœˆï¸' };
        const defaultItinerary = [];
        const defaultExpenses = [];
        const defaultUsers = ['æˆ‘', 'æ—…ä¼´A'];
        const defaultGuides = [];
        const defaultShopping = [];

        // --- Firebase Hook ---
        const useFirebaseSync = (collectionName, fieldName, defaultValue, tripId) => {
            const [data, setData] = useState(() => {
                try {
                    const local = window.localStorage.getItem(`${tripId}_${fieldName}`);
                    return local ? JSON.parse(local) : defaultValue;
                } catch { return defaultValue; }
            });
            const [isSyncing, setIsSyncing] = useState(false);
            const [isLoaded, setIsLoaded] = useState(false);

            useEffect(() => {
                if (!db || !tripId) {
                    setIsLoaded(true);
                    return;
                }
                const unsubscribe = db.collection(collectionName).doc(tripId)
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            const remoteData = doc.data()[fieldName];
                            if (remoteData !== undefined) {
                                setData(remoteData);
                                window.localStorage.setItem(`${tripId}_${fieldName}`, JSON.stringify(remoteData));
                            }
                        } else {
                            db.collection(collectionName).doc(tripId).set({ [fieldName]: defaultValue }, { merge: true });
                        }
                        setIsLoaded(true);
                    }, () => setIsLoaded(true));
                return () => unsubscribe();
            }, [collectionName, fieldName, tripId]);

            const updateData = async (newData) => {
                setData(newData);
                window.localStorage.setItem(`${tripId}_${fieldName}`, JSON.stringify(newData));
                if (db && tripId) {
                    setIsSyncing(true);
                    try {
                        await db.collection(collectionName).doc(tripId).update({ [fieldName]: newData });
                    } catch (e) {
                        if (e.code === 'not-found') await db.collection(collectionName).doc(tripId).set({ [fieldName]: newData }, { merge: true });
                    } finally {
                        setIsSyncing(false);
                    }
                }
            };
            return [data, updateData, isSyncing, isLoaded];
        };

        const Toast = ({ message, visible }) => {
            if (!visible) return null;
            return (
                <div className="fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-[var(--text-main)] text-white px-5 py-3 rounded-full shadow-xl z-[150] flex items-center gap-3 text-sm font-bold toast-enter border-2 border-white whitespace-nowrap">
                    <div className="bg-[var(--accent-green)] rounded-full p-1"><Icon name="Check" size={14} className="text-white" /></div>
                    {message}
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel, confirmText = "ç¢ºå®š", confirmColor = "btn-danger", isLoading = false }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[200] flex items-center justify-center p-4 animate-modal" onClick={!isLoading ? onCancel : undefined}>
                    <div className="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl relative border-4 border-[#F0E6DD]" onClick={e => e.stopPropagation()}>
                        <h3 className="text-xl font-black mb-2 text-[var(--text-main)]">{title}</h3>
                        {message && <p className="text-sm text-gray-500 mb-6 leading-relaxed">{message}</p>}
                        <div className="flex gap-3">
                            <button onClick={onCancel} disabled={isLoading} className="flex-1 py-3 text-gray-500 font-bold bg-gray-100 rounded-2xl btn-pill">å–æ¶ˆ</button>
                            <button onClick={onConfirm} disabled={isLoading} className={`flex-1 py-3 ${confirmColor} btn-pill font-bold shadow-lg`}>
                                {isLoading ? <div className="spinner"></div> : confirmText}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const generateDaysData = (startDateStr, duration) => {
            const days = [];
            const start = new Date(startDateStr);
            const weekDays = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
            for (let i = 0; i < duration; i++) {
                const current = new Date(start);
                current.setDate(start.getDate() + i);
                const month = current.getMonth() + 1;
                const date = current.getDate();
                const week = weekDays[current.getDay()];
                days.push({ day: i + 1, date: `${month}/${date}`, week: week });
            }
            return days;
        };

        // --- Background Stickers (Modified to be World Landmarks) ---
        const BackgroundStickers = () => (
            <div className="bg-sticker-layer">
                {/* ğŸ—¼ Tokyo Tower */}
                <div className="sticker text-7xl" style={{top: '5%', right: '8%', transform: 'rotate(10deg)'}}>ğŸ—¼</div>
                {/* ğŸ—½ Statue of Liberty */}
                <div className="sticker text-6xl" style={{bottom: '15%', left: '5%', transform: 'rotate(-10deg)'}}>ğŸ—½</div>
                {/* ğŸ—» Mount Fuji */}
                <div className="sticker text-6xl" style={{top: '20%', left: '10%', transform: 'rotate(-5deg)'}}>ğŸ—»</div>
                {/* ğŸ° European Castle */}
                <div className="sticker text-6xl" style={{bottom: '30%', right: '10%', transform: 'rotate(15deg)'}}>ğŸ°</div>
                {/* ğŸ—¿ Moai */}
                <div className="sticker text-5xl" style={{top: '50%', right: '80%', transform: 'rotate(20deg)', opacity: 0.3}}>ğŸ—¿</div>
                {/* âœˆï¸ Airplane */}
                <div className="sticker text-4xl" style={{top: '10%', left: '40%', opacity: 0.2, transform: 'rotate(45deg)'}}>âœˆï¸</div>
            </div>
        );

        // --- Landing Page ---
        const LandingView = ({ onJoin }) => {
            const [inputTripId, setInputTripId] = useState('');
            const [error, setError] = useState('');

            useEffect(() => {
                const lastId = window.localStorage.getItem('current_trip_id');
                if (lastId) setInputTripId(lastId);
            }, []);

            const handleSubmit = () => {
                if (!inputTripId.trim()) {
                    setError('è«‹è¼¸å…¥æ—…ç¨‹ ID');
                    return;
                }
                // Regex: Allow letters, numbers, underscore, hyphen
                const isValid = /^[a-zA-Z0-9_-]+$/.test(inputTripId);
                if (!isValid) {
                    setError('ID åªèƒ½åŒ…å«è‹±æ–‡å­—æ¯ã€æ•¸å­—ã€åº•ç·šæˆ–é€£å­—è™Ÿ');
                    return;
                }
                onJoin(inputTripId.trim());
            };

            return (
                <div className="landing-container page-enter">
                    <BackgroundStickers />
                    <div className="passport-card">
                        <div className="text-center mb-8">
                            <div className="w-20 h-20 bg-[var(--accent-main)] rounded-full mx-auto flex items-center justify-center text-white mb-4 shadow-lg border-4 border-white">
                                <Icon name="Plane" size={40} />
                            </div>
                            <h1 className="text-3xl font-black text-[var(--text-main)] tracking-tight">TRAVEL LOG</h1>
                            <p className="text-xs text-[var(--accent-main)] font-bold uppercase tracking-[0.2em] mt-1">Your Journey Starts Here</p>
                        </div>
                        
                        <div className="space-y-5">
                            <div>
                                <label className="text-xs font-bold text-gray-400 ml-1 mb-2 block flex items-center justify-center gap-1">
                                    <Icon name="Key" size={12}/> ENTER TRIP ID
                                </label>
                                <input 
                                    type="text" 
                                    value={inputTripId}
                                    onChange={(e) => { setInputTripId(e.target.value); setError(''); }}
                                    className="input-cute text-center font-mono text-xl tracking-wider uppercase border-2 focus:border-[var(--accent-main)] py-3"
                                    placeholder="e.g. TOKYO2026"
                                    onKeyDown={(e) => e.key === 'Enter' && handleSubmit()}
                                />
                                {error && <p className="text-red-400 text-xs font-bold mt-2 text-center animate-pulse">{error}</p>}
                            </div>
                            
                            <button onClick={handleSubmit} className="w-full py-4 btn-pill btn-primary shadow-xl text-lg mt-2 transition-transform active:scale-95">
                                <span>GO</span> <Icon name="ArrowRight" size={20} className="ml-2"/>
                            </button>
                        </div>
                    </div>
                    <div className="mt-8 text-[10px] text-gray-400 font-bold opacity-60">
                        Universal Travel Planner v4.1
                    </div>
                </div>
            );
        };

        // --- Main App Logic ---
        
        const ItineraryView = ({ items, setItems, settings, openSettings, showToast }) => {
            const [selectedDay, setSelectedDay] = useState(1);
            const [isAdding, setIsAdding] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const [newItem, setNewItem] = useState({ time: '', title: '', location: '', note: '' });
            const [deleteTarget, setDeleteTarget] = useState(null);
            const [isSaving, setIsSaving] = useState(false);
            
            const daysData = useMemo(() => generateDaysData(settings.startDate, settings.duration), [settings]);
            const filteredItems = items.filter(i => i.day === selectedDay).sort((a, b) => a.time.localeCompare(b.time));
            const isSpecialDay = daysData[selectedDay-1]?.week === 'é€±å…­' || daysData[selectedDay-1]?.week === 'é€±æ—¥';

            const confirmDelete = async () => {
                if (deleteTarget) {
                    setIsSaving(true);
                    await setItems(items.filter(i => i.id !== deleteTarget));
                    setIsSaving(false);
                    showToast("å·²åˆªé™¤");
                    setDeleteTarget(null);
                }
            };

            const handleAdd = async () => {
                if (!newItem.title) return;
                setIsSaving(true);
                await setItems([...items, { ...newItem, id: Date.now(), day: selectedDay }]);
                setIsSaving(false);
                setIsAdding(false); 
                setNewItem({ time: '', title: '', location: '', note: '' }); 
                showToast("å·²æ–°å¢");
            };

            const handleUpdate = async () => {
                if (!editingItem.title) return;
                setIsSaving(true);
                await setItems(items.map(i => i.id === editingItem.id ? editingItem : i));
                setIsSaving(false);
                setEditingItem(null); 
                showToast("å·²æ›´æ–°");
            };

            useEffect(() => { if (selectedDay > settings.duration) setSelectedDay(1); }, [settings.duration]);

            return (
                <div className="flex flex-col h-full w-full page-enter">
                    <BackgroundStickers />
                    <div className="scroll-container p-5">
                        <header className="mb-6 mt-2 flex justify-between items-start relative z-20">
                            <div>
                                <div className="text-xs font-bold text-[var(--accent-blue)] uppercase tracking-widest mb-1">Travel Plan</div>
                                <h1 className="text-2xl font-black text-[var(--text-main)] tracking-tight leading-tight max-w-[200px]">{settings.title}</h1>
                                <div className="text-xs text-gray-400 font-bold mt-1">{settings.startDate} å‡ºç™¼ â€¢ {settings.duration} å¤©</div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={openSettings} className="w-10 h-10 rounded-full bg-white shadow-md flex items-center justify-center text-gray-400 active:scale-95"><Icon name="Settings" size={20} /></button>
                                <button onClick={() => setIsAdding(true)} className="btn-pill btn-primary px-4 py-2 flex items-center gap-1 shadow-lg active:scale-95"><Icon name="Plus" size={18} /><span>æ–°å¢</span></button>
                            </div>
                        </header>

                        <div className="flex gap-3 mb-8 overflow-x-auto no-scrollbar pb-6 pt-2 snap-x snap-mandatory relative z-20 px-1">
                            {daysData.map(d => (
                                <button key={d.day} onClick={() => setSelectedDay(d.day)} className={`snap-center flex flex-col items-center justify-center min-w-[4.5rem] h-20 rounded-2xl transition-all duration-300 transform border-2 ${selectedDay === d.day ? (isSpecialDay ? 'date-active-snow border-transparent' : 'date-active border-transparent') : 'date-inactive'}`}>
                                    <span className={`text-[10px] font-bold mb-1 ${selectedDay === d.day ? 'opacity-90' : 'opacity-50'}`}>{d.week}</span>
                                    <span className="text-xl font-black tracking-tight">{d.date}</span>
                                </button>
                            ))}
                        </div>

                        <div className="relative z-10 pb-20 space-y-5">
                            {filteredItems.map((item, idx) => (
                                <div key={item.id} className="card-cute p-5 stagger-item cursor-pointer relative group overflow-hidden" style={{ animationDelay: `${idx * 0.08}s` }} onClick={() => setEditingItem(item)}>
                                    <div className={`absolute top-0 left-0 w-2 h-full ${isSpecialDay ? 'bg-[var(--accent-blue)]' : 'bg-[var(--accent-green)]'}`}></div>
                                    <div className="flex justify-between items-start mb-2 pl-2">
                                        <span className={`font-black font-mono text-xl px-2 py-0.5 rounded-md ${isSpecialDay ? 'text-[var(--accent-blue)] bg-blue-50' : 'text-[var(--accent-green)] bg-[#F0F7E6]'}`}>{item.time}</span>
                                        <button onClick={(e) => { e.stopPropagation(); setDeleteTarget(item.id); }} className="text-gray-300 hover:text-[var(--accent-pink)] p-1"><Icon name="Trash2" size={18} /></button>
                                    </div>
                                    <h3 className="font-bold text-lg mb-2 pl-2 text-[var(--text-main)]">{item.title}</h3>
                                    <div className="pl-2 space-y-2">
                                        {item.location && (
                                            <div className="flex justify-between items-center bg-[#F7FAFC] p-2 rounded-xl border border-gray-100">
                                                <div className="text-sm font-bold text-gray-500 flex items-center gap-1.5 truncate"><Icon name="MapPin" size={14} className="text-[var(--accent-pink)]" />{item.location}</div>
                                                <button className="btn-pill btn-secondary text-[10px] px-3 py-1 flex items-center gap-1" onClick={(e) => { e.stopPropagation(); window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`, '_blank')}}><Icon name="Navigation2" size={10} />MAP</button>
                                            </div>
                                        )}
                                        {item.note && <div className="sticky-note">{item.note.split('\n').map((line, i) => <div key={i}>{line}</div>)}</div>}
                                    </div>
                                </div>
                            ))}
                            {filteredItems.length === 0 && <div className="text-center py-20 opacity-40"><div className="text-5xl mb-3 grayscale">ğŸ’¤</div><div className="font-bold text-sm">æš«ç„¡è¡Œç¨‹</div></div>}
                        </div>
                    </div>

                    {(isAdding || editingItem) && (
                        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[100] flex items-center justify-center p-4 animate-modal" onClick={() => { if(!isSaving) { setIsAdding(false); setEditingItem(null); }}}>
                            <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl overflow-y-auto max-h-[85vh] relative border-4 border-[#F0E6DD]" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-black mb-6 text-[var(--text-main)] flex items-center gap-2">
                                    <span className="bg-[var(--accent-yellow)] w-8 h-8 rounded-full flex items-center justify-center text-white"><Icon name="PenLine" size={18}/></span>
                                    {isAdding ? 'æ–°å¢è¡Œç¨‹' : 'ç·¨è¼¯è¡Œç¨‹'}
                                </h3>
                                <div className="space-y-4">
                                    <div><label className="text-xs font-bold text-gray-400 ml-1">æ™‚é–“</label><input type="time" value={isAdding ? newItem.time : editingItem.time} onChange={e => isAdding ? setNewItem({...newItem, time: e.target.value}) : setEditingItem({...editingItem, time: e.target.value})} className="input-cute" /></div>
                                    <div><label className="text-xs font-bold text-gray-400 ml-1">æ¨™é¡Œ</label><input type="text" placeholder="ä¾‹ï¼šåƒæ‹‰éºµ" value={isAdding ? newItem.title : editingItem.title} onChange={e => isAdding ? setNewItem({...newItem, title: e.target.value}) : setEditingItem({...editingItem, title: e.target.value})} className="input-cute" /></div>
                                    <div><label className="text-xs font-bold text-gray-400 ml-1">åœ°é»</label><input type="text" placeholder="Google Maps åœ°é»" value={isAdding ? newItem.location : editingItem.location} onChange={e => isAdding ? setNewItem({...newItem, location: e.target.value}) : setEditingItem({...editingItem, location: e.target.value})} className="input-cute" /></div>
                                    <div><label className="text-xs font-bold text-gray-400 ml-1">ç­†è¨˜</label><textarea placeholder="å‚™è¨»äº‹é …..." value={isAdding ? newItem.note : editingItem.note} onChange={e => isAdding ? setNewItem({...newItem, note: e.target.value}) : setEditingItem({...editingItem, note: e.target.value})} className="input-cute h-24 resize-none"></textarea></div>
                                </div>
                                <div className="flex gap-3 mt-8">
                                    <button onClick={() => { setIsAdding(false); setEditingItem(null); }} disabled={isSaving} className="flex-1 py-3 text-gray-500 font-bold bg-gray-100 rounded-2xl btn-pill">å–æ¶ˆ</button>
                                    <button onClick={isAdding ? handleAdd : handleUpdate} disabled={isSaving} className="flex-1 py-3 btn-success btn-pill font-bold shadow-lg">{isSaving ? <div className="spinner"></div> : (isAdding ? 'åŠ å…¥' : 'æ›´æ–°')}</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <ConfirmModal isOpen={!!deleteTarget} title="åˆªé™¤è¡Œç¨‹ï¼Ÿ" onConfirm={confirmDelete} onCancel={() => setDeleteTarget(null)} isLoading={isSaving} />
                </div>
            );
        };

        const ShoppingView = ({ shopping, setShopping, showToast }) => {
            const [isAdding, setIsAdding] = useState(false);
            const [newItem, setNewItem] = useState({ name: '', price: '', note: '', image: '' });
            const [deleteTarget, setDeleteTarget] = useState(null);
            const [isSaving, setIsSaving] = useState(false);

            const handleAdd = async () => {
                if (!newItem.name) return;
                setIsSaving(true);
                await setShopping([...shopping, { ...newItem, id: Date.now(), bought: false }]);
                setIsSaving(false); setIsAdding(false); setNewItem({ name: '', price: '', note: '', image: '' }); showToast("å•†å“å·²æ–°å¢");
            };
            const toggleBought = async (item) => { setShopping(shopping.map(i => i.id === item.id ? { ...i, bought: !i.bought } : i)); };
            const confirmDelete = async () => {
                if (deleteTarget) { setIsSaving(true); await setShopping(shopping.filter(i => i.id !== deleteTarget)); setIsSaving(false); showToast("å·²åˆªé™¤"); setDeleteTarget(null); }
            };
            const handleSearchImage = (e, name) => {
                e.preventDefault(); e.stopPropagation();
                const searchTerm = (name && name.trim()) ? name : (newItem.image && !newItem.image.startsWith('http') ? newItem.image : null);
                if(!searchTerm) { showToast("è«‹å…ˆåœ¨ä¸Šæ–¹ã€å•†å“åç¨±ã€æ¬„ä½è¼¸å…¥æ–‡å­—å–” ğŸ˜…"); return; }
                const win = window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(searchTerm)}`, '_blank');
                if (!win) showToast("é–‹å•Ÿå¤±æ•—ï¼Œè«‹å…è¨±å½ˆè·³è¦–çª— âš ï¸");
            }
            const totalEstimated = shopping.reduce((acc, item) => acc + (parseFloat(item.price) || 0), 0);

            return (
                <div className="p-5 h-full relative z-10 animate-fade-in scroll-container page-enter">
                    <BackgroundStickers />
                    <header className="mb-6 flex justify-between items-center relative z-20">
                         <div><h1 className="text-3xl font-black text-[var(--text-main)] flex items-center gap-2">è³¼ç‰©æ¸…å–® <span className="text-2xl">ğŸ›ï¸</span></h1><div className="text-xs font-bold text-[var(--accent-purple)] mt-1 ml-1">é ç®—ç¸½è¨ˆ: Â¥{totalEstimated.toLocaleString()}</div></div>
                         <button onClick={() => setIsAdding(true)} className="w-10 h-10 rounded-full bg-[var(--accent-purple)] text-white shadow-lg flex items-center justify-center active:scale-90 transition-transform"><Icon name="Plus" size={20} strokeWidth={3}/></button>
                    </header>
                    <div className="grid grid-cols-2 gap-4 pb-24 relative z-10">
                        {shopping.map((item, i) => (
                            <div key={item.id} className="card-polaroid stagger-item relative" style={{animationDelay: `${i*0.05}s`}}>
                                <div className="absolute top-2 right-2 z-20 flex gap-1"><button onClick={() => setDeleteTarget(item.id)} className="w-6 h-6 bg-white/80 rounded-full flex items-center justify-center text-red-400 shadow-sm"><Icon name="Trash2" size={12} /></button></div>
                                <div className="polaroid-img overflow-hidden relative">
                                    {item.image ? <img src={item.image} alt={item.name} className="w-full h-full object-cover" onError={(e) => e.target.src = 'https://via.placeholder.com/150?text=No+Image'} /> : <div className="w-full h-full flex items-center justify-center text-gray-300 bg-gray-100"><Icon name="Image" size={32}/></div>}
                                    {item.bought && <div className="absolute inset-0 bg-black/40 flex items-center justify-center"><div className="bg-[var(--accent-green)] text-white px-3 py-1 rounded-full text-xs font-bold transform -rotate-12 border-2 border-white shadow-lg">BOUGHT!</div></div>}
                                </div>
                                <div className="text-center"><h4 className="font-bold text-[var(--text-main)] truncate text-sm">{item.name}</h4><div className="text-xs text-gray-400 font-mono mt-1">Â¥{item.price || '-'}</div><button onClick={() => toggleBought(item)} className={`mt-2 w-full py-1.5 rounded-md text-xs font-bold transition-colors ${item.bought ? 'bg-gray-100 text-gray-400' : 'bg-[var(--accent-purple)] text-white'}`}>{item.bought ? 'å·²è³¼è²·' : 'æ¨™ç¤ºè³¼è²·'}</button></div>
                            </div>
                        ))}
                        {shopping.length === 0 && <div className="col-span-2 text-center py-20 opacity-40"><div className="text-5xl mb-3 grayscale">ğŸ›’</div><div className="font-bold text-sm">é‚„æ²’æƒ³è²·çš„æ±è¥¿å—ï¼Ÿ</div></div>}
                    </div>
                    {isAdding && (
                        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[100] flex items-center justify-center p-4 animate-modal" onClick={() => { if(!isSaving) setIsAdding(false); }}>
                            <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl overflow-y-auto max-h-[85vh] relative border-4 border-[#F0E6DD]" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-black mb-4 text-[var(--text-main)]">æ–°å¢æƒ³è²·çš„æ±è¥¿</h3>
                                <div className="space-y-4">
                                    <div><label className="text-xs font-bold text-gray-400 ml-1">å•†å“åç¨±</label><input type="text" value={newItem.name} onChange={e => setNewItem({...newItem, name: e.target.value})} className="input-cute" placeholder="ä¾‹: Uniqlo ç™¼ç†±è¡£" /></div>
                                    <div><label className="text-xs font-bold text-gray-400 ml-1">é ä¼°åƒ¹æ ¼ (Â¥)</label><input type="number" value={newItem.price} onChange={e => setNewItem({...newItem, price: e.target.value})} className="input-cute" placeholder="1000" /></div>
                                    <div><label className="text-xs font-bold text-gray-400 ml-1 flex justify-between items-center"><span>åœ–ç‰‡ç¶²å€</span><span onClick={(e) => handleSearchImage(e, newItem.name)} className="text-[var(--accent-blue)] cursor-pointer hover:underline flex items-center gap-1 bg-blue-50 px-2 py-1 rounded-md transition-colors hover:bg-blue-100"><Icon name="Search" size={12}/> å» Google æ‰¾åœ–</span></label><div className="flex gap-2"><input type="text" value={newItem.image} onChange={e => setNewItem({...newItem, image: e.target.value})} className="input-cute" placeholder="è²¼ä¸Šåœ–ç‰‡é€£çµ..." /></div>{newItem.image && <div className="h-20 w-20 rounded-lg overflow-hidden border-2 border-gray-100 mt-2"><img src={newItem.image} className="w-full h-full object-cover" onError={(e) => e.target.style.display='none'}/></div>}</div>
                                </div>
                                <div className="flex gap-3 mt-6"><button onClick={() => setIsAdding(false)} disabled={isSaving} className="flex-1 py-3 text-gray-500 font-bold bg-gray-100 rounded-2xl btn-pill">å–æ¶ˆ</button><button onClick={handleAdd} disabled={isSaving} className="flex-1 py-3 btn-purple btn-pill font-bold shadow-lg">{isSaving ? <div className="spinner"></div> : 'åŠ å…¥æ¸…å–®'}</button></div>
                            </div>
                        </div>
                    )}
                    <ConfirmModal isOpen={!!deleteTarget} title="åˆªé™¤å•†å“ï¼Ÿ" onConfirm={confirmDelete} onCancel={() => setDeleteTarget(null)} isLoading={isSaving} />
                </div>
            );
        };

        const TabBar = ({ activeTab, setActiveTab }) => {
            const tabs = [
                { id: 'itinerary', label: 'è¡Œç¨‹', icon: 'Calendar', color: 'text-[var(--accent-green)]' },
                { id: 'guide', label: 'æ”»ç•¥', icon: 'BookOpen', color: 'text-[var(--accent-pink)]' },
                { id: 'shopping', label: 'è³¼ç‰©', icon: 'ShoppingBag', color: 'text-[var(--accent-purple)]' },
                { id: 'expenses', label: 'åˆ†å¸³', icon: 'Wallet', color: 'text-[var(--accent-yellow)]' },
            ];
            return (
                <div className="tab-bar-glass pb-safe-bottom pt-3 px-2 flex justify-around z-50">
                    {tabs.map(tab => (
                        <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center w-16 transition-all duration-300 active:scale-90 ${activeTab === tab.id ? '-translate-y-2' : 'opacity-40 hover:opacity-60'}`}>
                            <div className={`p-2.5 rounded-2xl transition-all duration-300 ${activeTab === tab.id ? 'bg-white shadow-md rotate-3' : 'bg-transparent'}`}><Icon name={tab.icon} size={24} className={activeTab === tab.id ? tab.color : "text-gray-500"} strokeWidth={activeTab === tab.id ? 3 : 2.5} /></div>
                            <span className={`text-[10px] mt-1 font-bold tracking-wide ${activeTab === tab.id ? 'text-[var(--text-main)]' : 'text-gray-400'}`}>{tab.label}</span>
                        </button>
                    ))}
                </div>
            );
        };

        const SettingsModal = ({ isOpen, onClose, settings, updateSettings, tripId, onReset, onChangeTrip }) => {
            if (!isOpen) return null;
            const [localSettings, setLocalSettings] = useState(settings);
            
            return (
                <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[150] flex items-center justify-center p-4 animate-modal" onClick={onClose}>
                    <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl border-4 border-[#F0E6DD]" onClick={e => e.stopPropagation()}>
                        <h3 className="text-xl font-black mb-4 text-[var(--text-main)] flex items-center gap-2"><Icon name="Settings" size={20} /> æ—…ç¨‹è¨­å®š</h3>
                        <div className="bg-blue-50 p-3 rounded-2xl border border-blue-100 mb-4 flex justify-between items-center">
                            <div><div className="text-[10px] font-bold text-blue-400">CURRENT TRIP ID</div><div className="font-mono font-bold text-blue-600">{tripId}</div></div>
                            <button onClick={onChangeTrip} className="text-xs bg-white px-3 py-1.5 rounded-full border border-blue-200 font-bold text-blue-500">åˆ‡æ›</button>
                        </div>
                        <div className="space-y-4">
                            <div><label className="text-xs font-bold text-gray-400 ml-1">æ—…ç¨‹åç¨±</label><input type="text" value={localSettings.title} onChange={e => setLocalSettings({...localSettings, title: e.target.value})} className="input-cute" /></div>
                            <div className="flex gap-3"><div className="flex-1"><label className="text-xs font-bold text-gray-400 ml-1">å‡ºç™¼æ—¥æœŸ</label><input type="date" value={localSettings.startDate} onChange={e => setLocalSettings({...localSettings, startDate: e.target.value})} className="input-cute" /></div><div className="w-24"><label className="text-xs font-bold text-gray-400 ml-1">å¤©æ•¸</label><input type="number" min="1" max="30" value={localSettings.duration} onChange={e => setLocalSettings({...localSettings, duration: parseInt(e.target.value)})} className="input-cute" /></div></div>
                        </div>
                        <div className="mt-8 space-y-3">
                            <button onClick={() => { updateSettings(localSettings); onClose(); }} className="w-full py-3 btn-success btn-pill font-bold shadow-lg">å„²å­˜è¨­å®š</button>
                            <button onClick={onReset} className="w-full py-3 text-red-400 font-bold bg-red-50 rounded-2xl btn-pill border border-red-100">æ¸…ç©ºæ­¤ ID çš„è³‡æ–™ (Reset)</button>
                        </div>
                    </div>
                </div>
            );
        };

        const ExpenseView = ({ expenses, setExpenses, users, setUsers, showToast }) => {
            const [newExp, setNewExp] = useState({ title: '', amount: '', payer: '' });
            const [involvedUsers, setInvolvedUsers] = useState([]); 
            const [isAddingUser, setIsAddingUser] = useState(false);
            const [newUserName, setNewUserName] = useState('');
            const [deleteTarget, setDeleteTarget] = useState(null); 
            const [userToDelete, setUserToDelete] = useState(null); 
            const [isSaving, setIsSaving] = useState(false);

            useEffect(() => { 
                if (users.length > 0) {
                    if (!newExp.payer) setNewExp(prev => ({ ...prev, payer: users[0] }));
                    if (involvedUsers.length === 0) setInvolvedUsers(users);
                } 
            }, [users]);

            const debtSummary = useMemo(() => {
                let balances = {}; users.forEach(u => balances[u] = 0);
                let totalSpent = 0;
                expenses.forEach(e => {
                    const payer = users.includes(e.payer) ? e.payer : users[0];
                    if (!payer) return;
                    const cost = parseFloat(e.amount); totalSpent += cost; balances[payer] += cost;
                    const splitTargets = e.involved && e.involved.length > 0 ? e.involved : users; 
                    const splitAmount = cost / splitTargets.length;
                    splitTargets.forEach(u => { if (balances[u] !== undefined) balances[u] -= splitAmount; });
                });
                const debts = [];
                const debtors = users.filter(u => balances[u] < -1).sort((a, b) => balances[a] - balances[b]);
                const creditors = users.filter(u => balances[u] > 1).sort((a, b) => balances[b] - balances[a]);
                let i = 0, j = 0;
                while (i < debtors.length && j < creditors.length) {
                    let debtor = debtors[i], creditor = creditors[j];
                    let amount = Math.min(Math.abs(balances[debtor]), balances[creditor]);
                    if (amount > 0) debts.push({ from: debtor, to: creditor, amount: Math.round(amount) });
                    balances[debtor] += amount; balances[creditor] -= amount;
                    if (Math.abs(balances[debtor]) < 1) i++; if (balances[creditor] < 1) j++;
                }
                return { debts, totalSpent };
            }, [expenses, users]);

            const handleAddUser = async () => { if (newUserName.trim() && !users.includes(newUserName.trim())) { setIsSaving(true); await setUsers([...users, newUserName.trim()]); setNewUserName(''); setIsAddingUser(false); setIsSaving(false); showToast("æˆå“¡å·²æ–°å¢"); } };
            const confirmDeleteUser = async () => { if (userToDelete) { setIsSaving(true); await setUsers(users.filter(user => user !== userToDelete)); setIsSaving(false); showToast("æˆå“¡å·²ç§»é™¤"); setUserToDelete(null); } };
            const toggleInvolved = (user) => { if (involvedUsers.includes(user)) { if (involvedUsers.length > 1) setInvolvedUsers(involvedUsers.filter(u => u !== user)); } else { setInvolvedUsers([...involvedUsers, user]); } };
            const handleAddExpense = async () => { if (!newExp.title || !newExp.amount) return; setIsSaving(true); await setExpenses([...expenses, { ...newExp, id: Date.now(), amount: parseFloat(newExp.amount), involved: involvedUsers }]); setNewExp({ title: '', amount: '', payer: users[0] || '' }); setInvolvedUsers(users); setIsSaving(false); showToast("è¨˜å¸³æˆåŠŸ"); };
            const confirmDeleteExpense = async () => { if (deleteTarget) { setIsSaving(true); await setExpenses(expenses.filter(e => e.id !== deleteTarget)); setIsSaving(false); showToast("å·²åˆªé™¤"); setDeleteTarget(null); } };

            return (
                <div className="p-5 h-full relative z-10 animate-fade-in scroll-container page-enter">
                    <BackgroundStickers />
                    <header className="mb-6 flex justify-between items-center relative z-20">
                         <h1 className="text-3xl font-black text-[var(--text-main)] mb-6 flex items-center gap-2">åˆ†å¸³å°å¹«æ‰‹ <span className="text-2xl">ğŸ’°</span></h1>
                    </header>
                    <div className="mb-6 flex flex-wrap gap-2 items-center relative z-20">
                        {users.map(u => (<div key={u} className="bg-white px-3 py-1.5 rounded-full text-sm font-bold text-gray-600 border border-gray-200 shadow-sm flex items-center gap-1"><div className="w-5 h-5 rounded-full bg-[var(--accent-blue)] text-white flex items-center justify-center text-[10px]">{u[0]}</div>{u}<button onClick={() => { if(users.length <= 1) return alert("è‡³å°‘ä¿ç•™ä¸€ä½æˆå“¡"); setUserToDelete(u); }} className="ml-1 text-gray-300 hover:text-red-400"><Icon name="X" size={12}/></button></div>))}
                        {isAddingUser ? (<div className="flex items-center gap-2 animate-fade-in"><input type="text" value={newUserName} onChange={e => setNewUserName(e.target.value)} className="input-cute py-1 px-3 mb-0 w-24 text-sm" placeholder="åå­—" autoFocus onKeyDown={e => e.key === 'Enter' && handleAddUser()}/><button onClick={handleAddUser} disabled={isSaving} className="btn-pill btn-warning px-3 py-1 text-xs shadow-md">{isSaving ? '...' : 'åŠ å…¥'}</button><button onClick={() => setIsAddingUser(false)} className="bg-gray-100 rounded-full w-6 h-6 flex items-center justify-center"><Icon name="X" size={12}/></button></div>) : (<button onClick={() => setIsAddingUser(true)} className="w-8 h-8 rounded-full bg-white border-2 border-dashed border-gray-300 text-gray-400 flex items-center justify-center hover:border-[var(--accent-yellow)] hover:text-[var(--accent-yellow)]"><Icon name="Plus" size={16}/></button>)}
                    </div>
                    <div className="card-cute p-6 mb-6 bg-gradient-to-br from-white to-[#FFFCF5]">
                        <div className="flex justify-between items-end mb-4"><h2 className="text-sm font-bold text-gray-400 uppercase tracking-widest">Total Spent</h2><span className="text-3xl font-black font-mono text-[var(--accent-yellow)]">Â¥{debtSummary.totalSpent.toLocaleString()}</span></div>
                        <div className="border-t-2 border-dashed border-gray-100 my-4"></div>
                        <div className="space-y-3">{debtSummary.debts.length === 0 ? <div className="text-center text-gray-400 text-sm font-bold">ç›®å‰æ²’æœ‰æ¬ æ¬¾ âœ¨</div> : debtSummary.debts.map((d, idx) => (<div key={idx} className="flex justify-between items-center bg-[#F7FAFC] p-3 rounded-xl"><div className="flex items-center gap-2"><span className="font-bold text-gray-600">{d.from}</span><Icon name="ArrowRight" size={14} className="text-gray-300"/><span className="font-bold text-gray-600">{d.to}</span></div><span className="font-mono font-bold text-[var(--text-main)]">Â¥{d.amount.toLocaleString()}</span></div>))}</div>
                    </div>
                    <div className="card-cute p-5 mb-6 relative z-10 border-l-4 border-l-[var(--accent-pink)]">
                        <h3 className="text-sm font-black text-gray-400 mb-3 uppercase tracking-wider">New Expense</h3>
                        <div className="space-y-3"><input type="text" placeholder="é …ç›® (ä¾‹: å±…é…’å±‹)" value={newExp.title} onChange={e => setNewExp({...newExp, title: e.target.value})} className="input-cute" /><div className="flex gap-2"><input type="number" placeholder="Â¥ é‡‘é¡" value={newExp.amount} onChange={e => setNewExp({...newExp, amount: e.target.value})} className="input-cute flex-1" /><div className="relative w-1/3"><select value={newExp.payer} onChange={e => setNewExp({...newExp, payer: e.target.value})} className="input-cute h-full appearance-none pr-8">{users.map(u => <option key={u} value={u}>{u} å…ˆä»˜</option>)}</select><Icon name="ChevronDown" size={16} className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"/></div></div><div className="bg-[#F7FAFC] p-3 rounded-xl"><div className="text-xs font-bold text-gray-400 mb-2">èª°è¦åˆ†æ”¤ï¼Ÿ(é»æ“Šåˆ‡æ›)</div><div className="flex flex-wrap gap-2">{users.map(u => { const isSelected = involvedUsers.includes(u); return (<button key={u} onClick={() => toggleInvolved(u)} className={`px-3 py-1.5 rounded-full text-xs font-bold transition-all border-2 ${isSelected ? 'bg-[var(--accent-blue)] text-white border-[var(--accent-blue)]' : 'bg-white text-gray-400 border-gray-200'}`}>{u}</button>); })}</div></div><button onClick={handleAddExpense} disabled={isSaving || !newExp.title || !newExp.amount} className="w-full btn-pill btn-primary py-3 shadow-lg flex justify-center items-center gap-2 mt-2">{isSaving ? <div className="spinner"></div> : <><Icon name="PlusCircle" size={18}/> è¨˜ä¸Šä¸€ç­†</>}</button></div>
                    </div>
                    <div className="space-y-3 pb-24 relative z-10">{expenses.slice().reverse().map((exp, idx) => (<div key={exp.id} className="bg-white/90 p-4 rounded-2xl shadow-sm flex justify-between items-center stagger-item border border-gray-50"><div><div className="font-bold text-[var(--text-main)]">{exp.title}</div><div className="text-xs text-gray-400 font-bold flex items-center gap-1 mt-1"><Icon name="User" size={10} /> {exp.payer} ä»˜æ¬¾ <Icon name="ArrowRight" size={10} className="ml-1"/> {exp.involved && exp.involved.length < users.length ? `${exp.involved.length} äººåˆ†` : 'å…¨å“¡'}</div></div><div className="flex items-center gap-3"><div className="font-mono font-bold text-lg text-[var(--accent-yellow)]">Â¥{exp.amount.toLocaleString()}</div><button onClick={() => setDeleteTarget(exp.id)} className="text-gray-200 hover:text-[var(--accent-pink)]"><Icon name="Trash2" size={16}/></button></div></div>))}</div>
                    <ConfirmModal isOpen={!!deleteTarget} title="åˆªé™¤æ¬¾é …ï¼Ÿ" onConfirm={confirmDeleteExpense} onCancel={() => setDeleteTarget(null)} isLoading={isSaving} />
                    <ConfirmModal isOpen={!!userToDelete} title={`ç§»é™¤ ${userToDelete}ï¼Ÿ`} message="æ³¨æ„ï¼šé€™ä¸æœƒè‡ªå‹•æ¸…é™¤ä»–å·²ä»˜çš„æ¬¾é …ç´€éŒ„ï¼Œè«‹ç¢ºèªå¸³å‹™å·²çµæ¸…ã€‚" onConfirm={confirmDeleteUser} onCancel={() => setUserToDelete(null)} isLoading={isSaving} />
                </div>
            );
        };

        // ... GuideView (Same logic, simple render) ...
        const GuideView = ({ guides, setGuides, showToast }) => {
            const [isAdding, setIsAdding] = useState(false);
            const [newGuide, setNewGuide] = useState({ title: '', content: '', type: 'transport' });
            const [deleteTarget, setDeleteTarget] = useState(null);
            const [isSaving, setIsSaving] = useState(false);
            const typeMap = { transport: { icon: 'TrainFront', color: 'text-blue-500', bg: 'bg-blue-100', label: 'äº¤é€š' }, ticket: { icon: 'Ticket', color: 'text-green-500', bg: 'bg-green-100', label: 'ç¥¨åˆ¸' }, spot: { icon: 'MapPin', color: 'text-red-500', bg: 'bg-red-100', label: 'æ™¯é»' }, shopping: { icon: 'ShoppingBag', color: 'text-orange-500', bg: 'bg-orange-100', label: 'è³¼ç‰©' } };
            const handleAdd = async () => { if (!newGuide.title) return; setIsSaving(true); await setGuides([...guides, { ...newGuide, id: Date.now() }]); setIsSaving(false); setIsAdding(false); setNewGuide({ title: '', content: '', type: 'transport' }); showToast("æ”»ç•¥å·²æ–°å¢"); };
            const confirmDelete = async () => { if (deleteTarget) { setIsSaving(true); await setGuides(guides.filter(g => g.id !== deleteTarget)); setIsSaving(false); showToast("å·²åˆªé™¤"); setDeleteTarget(null); } };
            return (
                <div className="p-5 h-full relative z-10 animate-fade-in scroll-container page-enter">
                    <BackgroundStickers />
                    <header className="mb-6 flex justify-between items-center relative z-20">
                         <h1 className="text-3xl font-black text-[var(--text-main)] flex items-center gap-2">æ—…è¡Œæ”»ç•¥ <span className="text-2xl">ğŸ“</span></h1>
                         <button onClick={() => setIsAdding(true)} className="w-10 h-10 rounded-full bg-[var(--accent-blue)] text-white shadow-lg flex items-center justify-center active:scale-90 transition-transform"><Icon name="Plus" size={20} strokeWidth={3}/></button>
                    </header>
                    <div className="space-y-4 pb-20 relative z-10">
                        {guides.map((g, i) => { const style = typeMap[g.type] || typeMap['transport']; return ( <div key={g.id} className="card-cute p-5 stagger-item relative group" style={{animationDelay: `${i*0.05}s`}}> <div className="flex items-center gap-3 mb-3"> <div className={`w-10 h-10 rounded-full ${style.bg} ${style.color} flex items-center justify-center shrink-0`}><Icon name={style.icon} size={20} /></div> <h3 className="text-lg font-bold text-[var(--text-main)] leading-tight">{g.title}</h3> <button onClick={() => setDeleteTarget(g.id)} className="ml-auto text-gray-200 hover:text-red-400"><Icon name="Trash2" size={16} /></button> </div> <div className="pl-[52px]"> <ul className="space-y-2"> {g.content.split('\n').map((line, idx) => ( <li key={idx} className="text-sm text-gray-600 leading-relaxed font-medium relative pl-3 before:content-['â€¢'] before:absolute before:left-0 before:text-gray-300">{line}</li> ))} </ul> </div> </div> ); })}
                    </div>
                    {isAdding && (
                        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[100] flex items-center justify-center p-4 animate-modal" onClick={() => { if(!isSaving) setIsAdding(false); }}>
                            <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl overflow-y-auto max-h-[85vh] relative border-4 border-[#F0E6DD]" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-black mb-4 text-[var(--text-main)]">æ–°å¢ç­†è¨˜</h3>
                                <div className="space-y-4">
                                    <input type="text" placeholder="æ¨™é¡Œ" value={newGuide.title} onChange={e => setNewGuide({...newGuide, title: e.target.value})} className="input-cute" />
                                    <div className="flex gap-2 mb-2 overflow-x-auto no-scrollbar pb-1">
                                        {Object.entries(typeMap).map(([key, val]) => (<button key={key} onClick={() => setNewGuide({...newGuide, type: key})} className={`px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap border-2 transition-all flex items-center gap-1 ${newGuide.type === key ? `border-${val.color.split('-')[1]}-400 bg-${val.color.split('-')[1]}-50 text-${val.color.split('-')[1]}-600` : 'border-gray-100 bg-gray-50 text-gray-400'}`}><Icon name={val.icon} size={14} /> {val.label}</button>))}
                                    </div>
                                    <textarea placeholder="å…§å®¹" value={newGuide.content} onChange={e => setNewGuide({...newGuide, content: e.target.value})} className="input-cute h-32 resize-none"></textarea>
                                </div>
                                <div className="flex gap-3 mt-6"><button onClick={() => setIsAdding(false)} disabled={isSaving} className="flex-1 py-3 text-gray-500 font-bold bg-gray-100 rounded-2xl btn-pill">å–æ¶ˆ</button><button onClick={handleAdd} disabled={isSaving} className="flex-1 py-3 btn-success btn-pill font-bold shadow-lg">{isSaving ? <div className="spinner"></div> : 'å„²å­˜'}</button></div>
                            </div>
                        </div>
                    )}
                    <ConfirmModal isOpen={!!deleteTarget} title="åˆªé™¤æ”»ç•¥ï¼Ÿ" onConfirm={confirmDelete} onCancel={() => setDeleteTarget(null)} isLoading={isSaving} />
                </div>
            );
        }

        const App = () => {
            // State for the entered trip ID (gatekeeper)
            const [tripId, setTripId] = useState('');
            const [entered, setEntered] = useState(false);

            // App States
            const [activeTab, setActiveTab] = useState('itinerary');
            const [showSettings, setShowSettings] = useState(false);
            const [toast, setToast] = useState({ msg: '', visible: false });

            // Data Hooks (Initialize with null tripId until entered)
            const activeTripId = entered ? tripId : null;
            
            const [settings, setSettings, syncingSettings] = useFirebaseSync('trips', 'settings', defaultSettings, activeTripId);
            const [itineraryItems, setItineraryItems, syncingItinerary] = useFirebaseSync('trips', 'itinerary', defaultItinerary, activeTripId);
            const [expenses, setExpenses, syncingExpenses] = useFirebaseSync('trips', 'expenses', defaultExpenses, activeTripId);
            const [users, setUsers, syncingUsers] = useFirebaseSync('trips', 'users', defaultUsers, activeTripId);
            const [guides, setGuides, syncingGuides] = useFirebaseSync('trips', 'guides', defaultGuides, activeTripId);
            const [shopping, setShopping, syncingShopping] = useFirebaseSync('trips', 'shopping', defaultShopping, activeTripId);

            const showToast = (msg) => { setToast({ msg, visible: true }); setTimeout(() => setToast({ msg: '', visible: false }), 2000); };

            const handleJoinTrip = (id) => {
                setTripId(id);
                window.localStorage.setItem('current_trip_id', id);
                setEntered(true);
            };

            const handleChangeTrip = () => {
                setEntered(false);
                setTripId('');
                setShowSettings(false);
                // Clear any data from view temporarily
            };

            const handleReset = async () => {
                if(confirm(`ç¢ºå®šé‡ç½® ID: ${tripId} çš„æ‰€æœ‰è³‡æ–™ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                    await setItineraryItems([]); await setExpenses([]); await setUsers(['æˆ‘', 'æ—…ä¼´A']); await setGuides([]); await setShopping([]); await setSettings(defaultSettings);
                    setShowSettings(false); showToast("è³‡æ–™å·²é‡ç½®");
                }
            };

            if (!entered) {
                return <LandingView onJoin={handleJoinTrip} />;
            }

            const renderContent = () => {
                switch(activeTab) {
                    case 'itinerary': return <ItineraryView items={itineraryItems} setItems={setItineraryItems} settings={settings} openSettings={() => setShowSettings(true)} showToast={showToast} isSyncing={syncingItinerary} />;
                    case 'guide': return <GuideView guides={guides} setGuides={setGuides} showToast={showToast} />;
                    case 'shopping': return <ShoppingView shopping={shopping} setShopping={setShopping} showToast={showToast} />;
                    case 'expenses': return <ExpenseView expenses={expenses} setExpenses={setExpenses} users={users} setUsers={setUsers} showToast={showToast} />;
                    default: return <ItineraryView items={itineraryItems} setItems={setItineraryItems} settings={settings} openSettings={() => setShowSettings(true)} showToast={showToast} />;
                }
            };

            return (
                <div id="app-container">
                    {(syncingSettings || syncingItinerary || syncingExpenses || syncingShopping) && <div className="fixed top-3 right-3 w-3 h-3 bg-[var(--accent-green)] rounded-full animate-ping z-[200]"></div>}
                    <div key={activeTab} style={{height: '100%', width: '100%', position: 'absolute', top: 0, left: 0}}>
                        {renderContent()}
                    </div>
                    <TabBar activeTab={activeTab} setActiveTab={setActiveTab} />
                    <Toast message={toast.msg} visible={toast.visible} />
                    <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} settings={settings} updateSettings={setSettings} tripId={tripId} onReset={handleReset} onChangeTrip={handleChangeTrip} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
